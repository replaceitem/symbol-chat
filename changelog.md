This is only a partial backport of the 1.2.2 1.20.5 version to 1.20.4